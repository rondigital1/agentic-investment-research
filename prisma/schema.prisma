// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id // store Clerk sub here
  email     String?
  createdAt DateTime @default(now())

  snapshots       PortfolioSnapshot[]
  researchReports ResearchReport[]
}

model PortfolioSnapshot {
  id        String   @id @default(uuid())
  userId    String
  source    String
  createdAt DateTime @default(now())

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  holdings        Holding[]
  researchReports ResearchReport[]

  @@index([userId, createdAt])
}

model Holding {
  id         String  @id @default(uuid())
  snapshotId String
  symbol     String
  shares     Float
  price      Float?
  assetClass String?

  snapshot PortfolioSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([snapshotId])
  @@index([symbol])
}

model ResearchReport {
  id         String   @id @default(cuid())
  userId     String
  snapshotId String? // optional: if you ever run a report without a snapshot
  runType    String   @default("WEEKLY") // e.g. WEEKLY, MANUAL, MONTHLY
  createdAt  DateTime @default(now())

  // What the system used as context (keep it structured)
  inputJson Json?

  // The final report content (markdown/plaintext)
  outputMd String

  // Operational fields (super useful later)
  status String  @default("SUCCESS") // SUCCESS | FAILED | RUNNING
  error  String?

  // Relations
  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshot PortfolioSnapshot? @relation(fields: [snapshotId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([snapshotId])
  @@index([runType, createdAt])
}
